# Яндекс-Мастерская Хакатон: Яндекс Музыка 2023

**Краткое описание:**

Обнаружение треков каверов - важная продуктовая задача, которая может значительно улучшить качество рекомендаций музыкального сервиса и повысить 
счастье наших пользователей. Если мы умеем с высокой точностью классифицировать каверы и связывать их между собой, то можно предложить 
пользователю новые возможности для управления потоком треков. 

 **Задача**

Реализовать ML-продукт:
 -  находящий в датасете композиции похожие на мелодию А (формирующий некую группу)
 — Ранжирующий все мелодии внутри группы по степени схожести (категориям): кавер, семпл, оригинал и т. д., а так же датам создания (формирующий некую линейку эволюции композиции)

# Содержание репозитория:

## 1. [Блокнот "знакомство с данными и первичная предобработка"](https://github.com/Sata9islav/Hackathons/blob/master/Yandex_music_2023/yandex_music_understending_and_preprocessing_by_team_13.ipynb)
### Основные шаги:
 - Поиск и устранение дубликатов
 - Заполнение пропусков
 - Корректировка значений

### Вывод по этапу:

   1. В датасете lyrics для id некоторых треков были обнаружены дубликаты текстов.
    Было проведено небольшое исследование на схожесть текстов каждого дубликата между собой.
    В качестве инструмента использовали меру Жаккара + n-граммы.
    Так некоторые тексты могли иметь не значительные отличия, но и полностью другой набор слов.
    Возможно данные загружали из разных источников. Из дубликатов текста было принято решение оставить наиболее 
    полные по количеству слов.
    Кроме дубликатов в датасете были обнаружены треки, для которых отсутствует разметка целевого признака,
    и они полностью не присутствуют в датасете covers. Такие треки тоже были удалены из набора.
   
   2. В датасете meta были:
 
    2.1 Скорректированы значения для даты и продолжительности трека.
        Во время обработки были обнаружены строки с небольшой длительность трека,
           возможно это сэмпл или рингтон, в дальнейшем выделим их в отдельные группы.
    2.2 Были выявлены дубликаты в процессе заполнения пропусков в колонке isrc.
        Одному треку могут соотвествовать несколько глобальных идентификаторов.
        Как инструмент заполнения был выбран ресурс musicbrainz и библиотека request.
        Кроме того, надежность источника выбранного для заполнения пропусков вызывает сомнение.
        Принимая во внимание такие факты, возникает вопрос о корректности изначальных значений
        в колонке и целесообразности ее дальнейшего использования.
    2.3 Колонка "язык песни" содержит большое количетсво пропусков.
        На данном этапе оставили пропуски без изменения,
        восстановим значения после того, как соберем единый датасет.
        Значения будем восстанавливать по тексту песни.

   3. Все текстовые значения датасетов были преведены к нижнему регистру.

## 2.  [Блокнот с исследовательским анализом и созданием новых признаков](https://github.com/Sata9islav/Hackathons/blob/master/Yandex_music_2023/yandex_music_eda_and_fe_by_team_13.ipynb)

### Основные шаги EDA:
 - Обнаружены и обработаны аномалии
 - Сгенерированы и исследованы новые признаки
 - Найдены и изучены закономерности
 - Исследованы основные признаки

### Выводы по этапу:

Было проведено исследование признаков композиций, в результате:

    1. Удалены обнаруженные аномалии, отсутствие значений для признака и некорректный текст для песни(состоял 
    только из ссылок)
    2. Обнаружен дисбаланс целевого признака, каверов значительно больше оригиналов.
    3. Выделены дополнительные признаки: количество слов в минуту, количетво знаков пункткуации в тексте 
    песни, средняя длина слова. Указанные признаки поомгут лучше показать модели разницу между оригиналом и 
    кавером.
    4. Были восстановлены языки исполнения песен по тексту песни. Для определения использовалась библиотека 
    langdetect. Исследлование по языкам показало, что самые популярные в наборе оказались - английский, русский 
    и испанский. У тайского языка оказалась самое выское значение для средней длины слова в тексте. Это вполне 
    может быть связано с особенностями язака.
    5. Проведено исследование дат. Количество добавленных треков с 2009 года постоянно растет,
    идет непрерывное пополнение базы. Каверов добавляется больше, чем оригиналов.
    Были подробно рассмотрены каждый год и проведено сравнение месяцев года
    между аналогичными по всем годам. Явных закономерностей не обнаружено.
    6. Произведена корректировка жанров песен. Изначально , признак содержал большое клоичество значений, это 
    были жанры, поджанры и более точечные категории поджанров. 
    Большое количество значений может негоавино отразиться на качестве будущей модели классификации. 
    Было принято решение объеденить поджанры с основными жанрами.
    Самыми популярными являются - pop, rock, metal,dance,electronic.
    7. Было проведено исследование кода isrc. По характеристикам кода удалось извлечь год регистрации и код 
    страны. Год регистрации не всегда совпадал с годом добавления в базу. Данные в Яндекс музыку загружали в
    произвольном порядке, т.е. нет порядка- сначала оригинал , а потом кавер.
    в базу добавляются песни из большого временного диапазона. Это может старая джазовая классика
    или современные хиты. 
    По коду страны самыми частыми cтали - Америка, Англия, Германия, Россия.
    8. Было выяснено, что каверы в среднем длятся дольше оригиналов.
    9. По части данных, для которых есть уникальный иденифитор оригинального трека удалось выяснить, 
    что на один трек может приходится до 30 каверов и изменений текста. 
    В среднем на трек приходится 11 каверов.
    10. Количество произносимых слов в минуту для оригиналов в среднем меньше, чем в каверах.
    11. В данных присутствуют не только песни, но и сэмплы, саундтреки, озвучка игр. А так же есть длительные 
    компиляции  песен для электронной музыки и другие.
    12. Проведено исследование на мультиколлинеарность, удалены слишком сильно коррелирующие
    и слабозначимые признаки.

## 3. [Блокнот с моделингом: отбор классификатора](https://github.com/Sata9islav/Hackathons/blob/master/Yandex_music_2023/yandex_music_modelling_clf_by_team_13.ipynb)

### Основные шаги:

 - Подготовка данных
 - Изучение признаков и их важности для модели
 - Отбор признаков
 - Сравнение моделей и выбор лучшей
 - Модификация модели

### Выводы по этапу

    В ходе работы:
    1. Произведена трансформация текстов и названий в векторное представление.
       Перед этим была произведена отчистка текста от символов и цифр.
       Для трансофрмации использовался Multi Universe Sentence Encoder.
       Мощный инструмент в области задач по обработке естественного языка.
    2. Произведен анализ значений признаков, численных и категориальных для того, чтобы
       выбрать подходящий метод кодировки с сохранением значимости признака.
       Сравнивалось три метода: бинарное кодирование, хэш-кодирование, кодирование на основе CatBoost.
       Решением стало бинарное кодирование, где каждое значение признака становится отделбьным бинарным 
       признаком. Не смотря на то, что такой подход значительно увеличивает признаковое пространство,
       в дальнейшем он позволил исключить слабозначимые признаки, и повысить качество модели.
    3. Для оценки модели взяты:
       - среднне гармоничное между полнотой и точностью,чтобы минимизировать количество ложных срабатываний,
       - roc_auc для того чтобы оценить разделяющую способность модели
    4. Исправлен дисбаланс целевого признака, путем увеличения в количестве примеров меньшего класса.
       Так же рассматривался метод уменьшения большего класса, но в связи с тем, что такой метод мог удалить 
       часть важной информации, он был отвергнут.
    5. Были выявлены наилучшие для модели признаки, и отсееены слабозначимые, оказывавшие отрицательное
       влияние на качество модели. Использовался SequentialFeatureSelector, последовательный отбор признаков.
       Такой метод более ресурсоемкий, но результат на выходе дал прирост к метрике.
    6. Для улучшения качества предсказаний векторные эмбединги и численные признаки были соеденены в один 
       набор.
    7. Для масштабирования данных выбран RobustScaler, он не боится выбросов и подходит для несимметричных 
       данных.
    8. Были рассмотрены несколько моделей классификации: логистическая регрессия, метод опорных векторов, 
       градиентный бустинг. Модели подбирались из соображения размера признакового пространства.
       Предварительно мы взяли за основу логистическую регрессию, и последовательно улучшали ее метрику.
       В финальной итерации сравнения бустинг показал лучшие качества и наилучшее время работы.
    9. Была сделана попытка подбора  порога разделения на классы, но качество метрики не улучшилось.



    В результате работы была выбрана наилучшая модель Градиентный бустинг, и достигнуто для нее высокое 
    качество классификации музыкальных треков на оригинал/кавер.

## 4. [Блокнот с моделлингом: поиск похожих композиций и ранжирование](https://github.com/Sata9islav/Hackathons/blob/master/Yandex_music_2023/yandex_music_modelling_faiss_by_team_13.ipynb)

### Основные шаги:

 - Подготовка данных
 - Реализация алгоритма поиска похожих треков
 - Ранжирование треков внутри группы

### Выводы по этапу:

Был реализован поиск похожих композиций с помощью библиотеки FAISS. С помощью нее
    осуществляется поиск в векторном пространстве группы похожих треков, благодаря оптимизации  в части 
    использования памяти, поиск на больших батчах не будет заниматься много времени.

    Так же было добавлено ранжирование найденной группы по типу трека (оригина, а потом кавер), и внутреннее 
    ранжирование для каждой групп по году исполнения. Год исполнения (год регистрации) был взят из кода isrc.

    Такой подход позволит пользователю более точно настраивать свою ленту рекомендаций.

# Итоги работы:

 - Был разработан алгоритм классифкации, который может эффективно отличить оригинал от кавера.   
 - Реализован алгоритм поиска группы похожих композиций для указанного трека с ранжированием внутри группы по типу трека и года выпуска.
 
 Разработанные ML-продукты помомогут улучшить качество сервиса: пользователи смогут более точно настраивать плейлист под свои предпочтения. 

# Состав команды:

- [Станислав](https://github.com/Sata9islav)
- [Илья](https://github.com/tkachuk45)
